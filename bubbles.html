<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Bubble Chart</title>
    <script src="{{ url_for('static', filename='js/d3.min.js') }}"></script>
    <style>
        /* Same styles as before */
    </style>
</head>
<body>
    <!-- HTML Structure remains the same -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            d3.json('/data').then(function (data) {
                // Initialize the bubble chart as before

                function addClickListeners() {
                    bubbles.on("click", function (event, d) {
                        fetch(`/graph/${d.A}`)
                            .then(response => response.json())
                            .then(graphData => {
                                document.getElementById('graph-content').innerHTML = ''; // Clear previous graph content
                                document.getElementById('graph-container').style.display = 'block'; // Show the graph container

                                const svgGraph = d3.select("#graph-content").append("svg")
                                    .attr("width", width)
                                    .attr("height", height);

                                // Increase the link distance and the strength of the link force
                                const linkForce = d3.forceLink(graphData.links)
                                    .id(d => d.id)
                                    .distance(300)  // Increased the distance to spread out nodes
                                    .strength(1);

                                const simulationGraph = d3.forceSimulation(graphData.nodes)
                                    .force("link", linkForce)
                                    .force("charge", d3.forceManyBody().strength(-400))  // Stronger repulsion to spread nodes
                                    .force("center", d3.forceCenter(width / 2, height / 2))
                                    .force("collision", d3.forceCollide().radius(50))
                                    .on("tick", tickedGraph);

                                // Function to create curved paths (arc) for the links
                                function curvedLink(d) {
                                    const dx = d.target.x - d.source.x,
                                          dy = d.target.y - d.source.y,
                                          dr = Math.sqrt(dx * dx + dy * dy) * 1.5;  // Adjust the curvature multiplier for more spacing

                                    return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                                }

                                // Define the links with curved paths
                                const link = svgGraph.append("g")
                                    .selectAll("path")
                                    .data(graphData.links)
                                    .enter().append("path")
                                    .attr("class", "link")
                                    .attr("stroke-width", 2)
                                    .attr("stroke", "#999")
                                    .attr("fill", "none")
                                    .attr("marker-end", "url(#arrow)");

                                const node = svgGraph.append("g")
                                    .selectAll("circle")
                                    .data(graphData.nodes)
                                    .enter().append("circle")
                                    .attr("r", 15)
                                    .attr("fill", d => d.group === 1 ? "#1f77b4" : "#ff7f0e");

                                const label = svgGraph.append("g")
                                    .selectAll("text")
                                    .data(graphData.nodes)
                                    .enter().append("text")
                                    .attr("dy", -15)
                                    .attr("text-anchor", "middle")
                                    .text(d => d.id);

                                // Add text along the curved links for F and G data
                                const linkLabels = svgGraph.append("g")
                                    .selectAll(".link-label")
                                    .data(graphData.links)
                                    .enter().append("text")
                                    .attr("class", "link-label")
                                    .attr("dy", -5)  // Position slightly above the line
                                    .attr("text-anchor", "middle")
                                    .style("font-size", "12px")
                                    .style("fill", "#333")
                                    .text(d => `${d.f_data} - ${d.g_data}`);  // Add F and G data on the link

                                function tickedGraph() {
                                    // Update the link paths to be curved
                                    link.attr("d", curvedLink);

                                    node.attr("cx", d => d.x)
                                        .attr("cy", d => d.y);

                                    label.attr("x", d => d.x)
                                        .attr("y", d => d.y);

                                    // Update the position of the link labels to follow the curved path
                                    linkLabels
                                        .attr("x", d => (d.source.x + d.target.x) / 2)
                                        .attr("y", d => (d.source.y + d.target.y) / 2)
                                        .attr("transform", function(d) {
                                            const angle = Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * 180 / Math.PI;
                                            return `rotate(${angle}, ${(d.source.x + d.target.x) / 2}, ${(d.source.y + d.target.y) / 2})`;
                                        });
                                }

                                // Arrow marker definition
                                svgGraph.append("defs").append("marker")
                                    .attr("id", "arrow")
                                    .attr("viewBox", "0 -5 10 10")
                                    .attr("refX", 15)  // Adjusted to align the arrow properly with the line
                                    .attr("refY", 0)
                                    .attr("markerWidth", 6)
                                    .attr("markerHeight", 6)
                                    .attr("orient", "auto")
                                    .append("path")
                                    .attr("d", "M0,-5L10,0L0,5")
                                    .attr("fill", "#999");
                            })
                            .catch(error => console.error('Error fetching graph data:', error));
                    });
                }

                // Call the function to attach click listeners initially
                addClickListeners();

                // Search box filtering logic remains the same

                function ticked() {
                    bubbles.attr("transform", d => `translate(${d.x},${d.y})`);
                }

                // Handle window resizing
                window.addEventListener('resize', function() {
                    const newWidth = window.innerWidth;
                    const newHeight = window.innerHeight;
                    svg.attr("width", newWidth).attr("height", newHeight);
                    simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
                    simulation.alpha(0.5).restart();
                });

                document.getElementById('close-graph').addEventListener('click', function () {
                    document.getElementById('graph-container').style.display = 'none';
                });
            }).catch(function (error) {
                console.error('Error fetching data:', error);
            });
        });
    </script>
</body>
</html>